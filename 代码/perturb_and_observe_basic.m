%% 光伏参数定义部分
% 这部分设置了光伏电池的基本电气参数和环境常数，用于后续计算光伏特性曲线和MPPT算法。
V_oc = 36.6;       % 开路电压(V)，表示光伏电池在无负载条件下能达到的最大电压值
I_sc = 6.2;        % 短路电流(A)，表示光伏电池在短路条件下流过的最大电流值
I_o  = 3e-10;      % 反向饱和电流(A)，是二极管方程中的关键参数，影响电池的暗电流特性
q = 1.6e-19;       % 元电荷(C)，是电子的电荷量，用于计算PN结电压电流关系
n = 1;             % 理想因子，反映二极管非理想程度，通常取值1~2
k = 1.38e-23;      % 玻尔兹曼常数(J/K)，热力学常数，用于计算热电压
R_sh = 300;        % 并联电阻(Ω)，模拟光伏电池的旁路漏电效应
T = 298;           % 温度(K)，光伏电池的工作温度，对应25摄氏度
num_c = 60;        % 串联电池数目，整个光伏组件由60个单体电池串联而成
P_threshold = 2;   % 功率阈值(W)，用于变步长算法中判断是否远离功率峰值
V_threshold = 1;   % 电压阈值(V)，用于变步长算法中判断是否接近功率峰值

% 变步长系数定义
% 这些系数控制扰动观察法的步长调整策略，实现在不同功率变化区域采用不同步长以提高跟踪效率
k1 = 0.2;          % 远离峰值时的步长系数，采用较大步长快速接近最大功率点
k2 = 0.02;         % 接近峰值时的步长系数，采用较小步长精细调整避免振荡

%% 光伏特性曲线计算部分
% 通过单二极管模型计算光伏电池的I-V和P-V特性曲线，生成用于MPPT算法的基础数据
V_PV = linspace(0, V_oc, 1000).';  % 生成从0到开路电压的1000个均匀分布的电压点，转置为列向量
I_ph = I_sc;        % 光生电流，理想情况下等于短路电流
% 计算二极管的暗电流分量，使用肖克利二极管方程
I1 = I_o * (exp((q*V_PV)./(n*k*T*num_c)) - 1);
I2 = V_PV / R_sh;   % 计算并联电阻引起的漏电流
I_PV = I_ph - I1 - I2;  % 总输出电流 = 光生电流 - 暗电流 - 漏电流
I_PV = max(I_PV, 0);  % 保证电流非负，避免物理上不可能的负电流值
P = V_PV .* I_PV;   % 计算功率曲线，功率 = 电压 × 电流

% 将数据整理为表格形式，便于后续处理和分析
S = table(V_PV, I_PV, P, 'VariableNames', {'V','I','P'}); % 创建表格S，包含电压、电流和功率三列

%% MPPT算法初始化部分
% 设置算法迭代所需的初始参数和存储变量
N   = height(S);    % 获取数据表格的行数，即电压点的总数
dV  = mean(diff(S.V)); % 计算电压点的平均间隔，作为基础步长参考
iter = 1000;        % 设置最大迭代次数，确保算法能在有限步内收敛
idx = 1;            % 初始化电压索引，从第一个电压点开始搜索

% 预分配数组用于记录迭代过程数据，便于后续分析算法收敛性能
V_s = zeros(1,iter);  % 记录每次迭代的电压值
I_s = zeros(1,iter);  % 记录每次迭代的电流值
P_s = zeros(1,iter);  % 记录每次迭代的功率值

%% 变步长扰动观察法主循环
% 通过迭代调整工作点，跟踪最大功率点位置
for k = 1:iter
    % 获取当前工作点的电压和功率值
    V = S.V(idx);   % 当前电压值
    P = S.P(idx);   % 当前功率值
    % 获取相邻电压点的值用于计算变化量
    V_new = S.V(idx + 1);  % 下一个电压点的值
    P_new = S.P(idx + 1);  % 下一个电压点对应的功率值
    dP = P_new - P;        % 计算功率变化量，用于判断功率变化趋势
    dV = V_new - V;        % 计算电压变化量，即基础电压步长

    % 记录当前迭代的数据
    V_s(k) = V;    % 记录当前电压
    P_s(k) = P;    % 记录当前功率

    % 计算功率对电压的变化方向（斜率符号）
    % sign函数返回dP*dV的符号：正号表示同向变化，负号表示反向变化
    sgn = sign(dP * dV);

    % 变步长策略：根据功率变化幅度和电压变化幅度动态调整步长
    if abs(dP) > P_threshold
        step = k1 * abs(dP);  % 当功率变化较大时，认为远离峰值，采用大步长快速接近
    elseif abs(dV) < V_threshold
        step = k2 * abs(dP);  % 当电压变化较小时，认为接近峰值，采用小步长精细调整
    else
        step = 0.1;  % 默认步长，用于中间状态
    end

    % 将电压步长转换为数据表格中的索引偏移量
    % 确保步长至少对应1个索引单位，避免除零错误
    step_idx = max(1, round(step / max(dV, 1e-9)));
    % 计算新索引位置，根据斜率符号决定搜索方向
    idx_new = idx + sgn * step_idx;
    % 限制索引在有效范围内[1, N-1]，避免越界
    idx = min(max(idx_new, 1), N-1);
end

%% 输出最终结果
% 算法收敛后，获取最大功率点对应的电压和功率值
V_mppt = S.V(idx);  % 最大功率点电压
P_mppt = S.P(idx);  % 最大功率点功率

%% 结果可视化部分
% 绘制I-V特性曲线，展示光伏电池的电流电压关系
figure; 
plot(S.V, S.I, '-b');  % 绘制I-V曲线，蓝色实线
xlabel('Voltage (V)');  % X轴标签：电压
ylabel('Current (A)');  % Y轴标签：电流
title('I–V');          % 图表标题：I-V特性曲线
hold on; 
plot(V_mppt, S.I(idx), 'ro');  % 在曲线上标记最大功率点，红色圆圈

% 绘制P-V特性曲线，展示光伏电池的功率电压关系
figure; 
plot(S.V, S.P, '-r');  % 绘制P-V曲线，红色实线
xlabel('Voltage (V)');  % X轴标签：电压
ylabel('Power (W)');    % Y轴标签：功率
title('P–V');          % 图表标题：P-V特性曲线
hold on; 
plot(V_mppt, P_mppt, 'ko');  % 标记最大功率点，黑色圆圈

% 绘制功率迭代过程，展示算法收敛性能
figure; 
plot(P_s,'LineWidth',1.2);  % 绘制功率随迭代次数的变化曲线
xlabel('迭代过程');          % X轴标签：迭代次数
ylabel('P (W)');            % Y轴标签：功率

% 绘制电压迭代过程，展示工作点电压的变化
figure; 
plot(V_s,'LineWidth',1.2);  % 绘制电压随迭代次数的变化曲线  
xlabel('迭代过程');          % X轴标签：迭代次数
ylabel('V_{pv} (V)');       % Y轴标签：光伏电压
